pipeline {
  agent { docker { image 'ci-agent' } }

  parameters {
    string(name: 'XRAY_PROJECT_KEY',  defaultValue: 'QT2',  description: 'Xray Project Key')
    string(name: 'XRAY_TESTPLAN_KEY', defaultValue: '',     description: 'Opsional: Test Plan Key (kosongkan jika tidak dipakai)')
  }

  environment {
    XRAY_CLIENT_ID     = credentials('xray-client-id')
    XRAY_CLIENT_SECRET = credentials('xray-client-secret')
  }

  stages {
    stage('Clone') {
      steps { checkout scm }
    }

    stage('Run Maven Test') {
      steps {
        dir('ui') {
          sh '''
            set -e
            rm -rf ui/allure-results reports || true
            mkdir -p reports
            mvn -B clean test

            # pastikan ada report JUnit
            ls target/surefire-reports/TEST-*.xml >/dev/null 2>&1 || {
              echo "ERROR: Tidak ada JUnit report di ui/target/surefire-reports"
              exit 1
            }
          '''
        }
      }
      post {
        always {
          junit 'ui/target/surefire-reports/*.xml'
          archiveArtifacts artifacts: 'ui/target/surefire-reports/**', fingerprint: true
        }
      }
    }
    stage('Publish Results to Xray') {
      steps {
        dir('ui') {
          sh '''
            set -eu
            mkdir -p reports

            # Auth
            XRAY_TOKEN=$(
              printf '{"client_id":"%s","client_secret":"%s"}' "$XRAY_CLIENT_ID" "$XRAY_CLIENT_SECRET" |
              curl -fsS -X POST "https://xray.cloud.getxray.app/api/v2/authenticate" \
                   -H "Content-Type: application/json" --data @- | tr -d '"'
            )
            [ -n "$XRAY_TOKEN" ] || { echo "ERROR: gagal dapat token"; exit 1; }

            # File JUnit
            FILE="target/surefire-reports/TEST-TestRunner.xml"
            [ -s "$FILE" ] || { echo "ERROR: $FILE tidak ditemukan / kosong"; exit 1; }
            grep -q "<testsuite" "$FILE" || { echo "ERROR: $FILE bukan JUnit XML"; exit 1; }

            # Query string
            QS="projectKey=${XRAY_PROJECT_KEY}"
            [ -n "${XRAY_TESTPLAN_KEY:-}" ] && QS="${QS}&testPlanKey=${XRAY_TESTPLAN_KEY}"

            # Upload: single file, text/xml
            HTTP_CODE=$(
              curl -sS -w "%{http_code}" -o reports/xray-import.json \
                -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/junit?${QS}" \
                -H "Authorization: Bearer ${XRAY_TOKEN}" \
                -H "Content-Type: text/xml" \
                --data-binary @"$FILE"
            )

            case "$HTTP_CODE" in
              200|201) : ;;
              *)  echo "ERROR: Xray import gagal (HTTP $HTTP_CODE)"
                  echo "--- Response ---"
                  head -n 80 reports/xray-import.json || true
                  echo "--- Head of $FILE ---"
                  head -n 40 "$FILE" || true
                  exit 1
                  ;;
            esac
          '''
        }
      }
      post {
        always { archiveArtifacts artifacts: 'ui/reports/xray-import.json', fingerprint: true }
      }
    }
    stage('Allure Report') {
      steps {
        allure([
          results: [[path: 'ui/allure-results']]
        ])
      }
    }
  }
}
